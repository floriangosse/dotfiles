#!/usr/bin/env bash

if [[ $1 == "--nv" ]]; then
    git push --no-verify
else
    git push
fi

if ! command -v gh > /dev/null; then
    echo >&2 "Command 'gh' not available. Skip creating pull request."
    exit
fi

branch=$(git branch --format "%(refname:short)" | awk '{ print tolower($0) }')
if [[ $branch =~ [a-z]{1,}-[0-9]{1,} ]]; then
    ticket=$(echo "$branch" | sed -E -e 's/([a-z]{1,}-[0-9]{1,})_.*/\1/g' | awk '{ print toupper($0) }')
    title=$(echo "$branch" | sed -E -e 's/[a-z]{1,}-[0-9]{1,}_(.*)/\1/g' -e 's/-/ /g')
    capitalized_title="$(echo ${title:0:1} | tr '[a-z]' '[A-Z]')${title:1}"

    open_patches=$(gh pr list --head "$branch" --json "number" --jq "length")
    if [[ "$open_patches" -eq "0" ]]; then
        gh pr create --assignee @me --title "[$ticket] ${capitalized_title}" --body "resolves $ticket" --draft --base develop
    fi
fi
