# Extract configuration
# Enable interactive comments
setopt interactivecomments

# Enable auto cd
setopt auto_cd

# zmv
autoload -U zmv
alias zmv='noglob zmv'


source ~/.zsh/completion.zsh
source ~/.zsh/keybindings.zsh
source ~/.zsh/history.zsh
source ~/.zsh/clipboard.zsh
source ~/.zsh/functions.zsh
source ~/.zsh/aliases.zsh

# Load z if installed
if [[ -f ~/.zsh/plugins/z/z.sh ]]; then
    source ~/.zsh/plugins/z/z.sh
fi

# Load nvm if installed
export NVM_DIR="$HOME/.nvm"

# Setup default Node path for global packages
_setup_default_node_path() {
    if [[ -f "$NVM_DIR/alias/default" ]]; then
        local default_version=$(cat "$NVM_DIR/alias/default")
    elif [[ -d "$NVM_DIR/versions/node" ]]; then
        local default_version=$(ls "$NVM_DIR/versions/node" | tail -1)
    else
        return
    fi

    local node_bin_path="$NVM_DIR/versions/node/$default_version/bin"
    if [[ -d "$node_bin_path" ]] && [[ ":$PATH:" != *":$node_bin_path:"* ]]; then
        export PATH="$node_bin_path:$PATH"
    fi
}

_load_nvm() {
    if [[ -z "$NVM_LOADED" ]]; then
        unalias nvm node npm npx 2>/dev/null || true
        [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
        [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"
        export NVM_LOADED=1
    fi
}

_nvm_smart_wrapper() {
    local cmd="$1"
    shift

    if command -v "$cmd" >/dev/null 2>&1; then
        "$cmd" "$@"
    else
        load_nvm
        "$cmd" "$@"
    fi
}

_setup_default_node_path

alias nvm='_load_nvm && nvm'
alias node='_nvm_smart_wrapper node'
alias npm='_nvm_smart_wrapper npm'
alias npx='_nvm_smart_wrapper npx'

# Load local zshrc if available
if [[ -f ~/.zshrc.local ]]; then
    source ~/.zshrc.local
fi

# Load zsh-syntax-highlighting if installed
if [[ -f ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
    # Configuration for zsh-syntax-highlighting
    # TODO: Extract configuration
    ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets pattern)
    ZSH_HIGHLIGHT_PATTERNS+=('rm -rf *' 'fg=white,bold,bg=red')

    source ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

export PATH="/usr/local/go/bin:$PATH"
export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"
export PATH="${HOME}/.bin:${HOME}/.local/bin:${PATH}"

# Load the theme
source ~/.zsh/theme.zsh

export PATH="${HOME}/.bin:${PATH}"
